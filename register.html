<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <div id="alertBox" class="alert d-none text-center" role="alert"></div>

    <div class="card shadow-lg p-4" id="formCard">
      <h3 class="mb-3 text-center">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h3>
      <p class="text-center">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì <strong><span id="lineName">...</span></strong></p>
      <form id="registerForm">
        <div class="mb-3">
          <label for="name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input type="text" class="form-control" id="name" required />
        </div>
        <div class="mb-3">
          <label for="nationalId" class="form-label">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
          <input type="text" class="form-control" id="nationalId" maxlength="13" required />
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <input type="tel" class="form-control" id="phone" required />
        </div>
        <input type="hidden" id="userId" />
        <button type="submit" class="btn btn-success w-100">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
      </form>
    </div>
  </div>

  <script>
    const liffId = "2007284346-W3BaQ64M"; // ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const gasUrl = "https://script.google.com/macros/s/AKfycbwWyl0zw6pGwzT9rR9gKHAV6pTnvFRJoDGsQH9b9AXnKuWqyArEukqcTwA9GXYniYZiqA/exec"; // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script
    const telegramToken = "YOUR_TELEGRAM_BOT_TOKEN"; // ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const telegramChatId = "YOUR_TELEGRAM_CHAT_ID"; // ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    document.addEventListener("DOMContentLoaded", async function () {
      try {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        document.getElementById("lineName").innerText = profile.displayName;
        document.getElementById("userId").value = profile.userId;

        // üîé ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ userId ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Google Sheet ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        const res = await fetch(gasUrl);
        const data = await res.json();
        const found = data.find(row => row.userId === profile.userId);

        if (found) {
          showAlert("üö® ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß", "danger");
          document.getElementById("formCard").classList.add("d-none");
        }
      } catch (err) {
        showAlert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: " + err.message, "danger");
      }

      // ‚è≥ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
      document.getElementById("registerForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const name = document.getElementById("name").value.trim();
        const nationalId = document.getElementById("nationalId").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const userId = document.getElementById("userId").value;

        if (!/^\d{13}$/.test(nationalId)) {
          showAlert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (13 ‡∏´‡∏•‡∏±‡∏Å)", "warning");
          return;
        }

        // üîê Hash nationalId
        const nationalIdHash = CryptoJS.SHA256(nationalId).toString();

        try {
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥‡∏Å‡πà‡∏≠‡∏ô POST
          const checkRes = await fetch(gasUrl);
          const existing = await checkRes.json();
          const duplicate = existing.find(row => row.userId === userId);
          if (duplicate) {
            showAlert("üö® ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß", "danger");
            return;
          }

          const body = {
            name,
            nationalId: nationalIdHash,
            phone,
            userId
          };

          const sheetRes = await fetch(gasUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });

          const result = await sheetRes.json();

          if (result.status === "duplicate") {
            showAlert("üö® ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß", "danger");
            return;
          } else if (result.status === "success") {
            showAlert("‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ", "success");
            sendTelegram(`üìù ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà\nüë§ ‡∏ä‡∏∑‡πà‡∏≠: ${name}\nüì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${phone}`);
            document.getElementById("registerForm").reset();
            document.getElementById("formCard").classList.add("d-none");
          } else {
            showAlert("‚ùå ‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", "danger");
          }
        } catch (error) {
          showAlert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message, "danger");
        }
      });
    });

    function showAlert(message, type = "info") {
      const box = document.getElementById("alertBox");
      box.innerText = message;
      box.className = `alert alert-${type} text-center`;
      box.classList.remove("d-none");
    }

    async function sendTelegram(msg) {
      const url = `https://api.telegram.org/bot${telegramToken}/sendMessage`;
      await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: telegramChatId,
          text: msg,
          parse_mode: "HTML"
        })
      });
    }
  </script>
</body>
</html>

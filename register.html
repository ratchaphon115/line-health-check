<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <div class="card shadow-lg p-4">
      <h3 class="mb-3 text-center">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h3>
      <p class="text-center">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì <strong><span id="lineName">...</span></strong></p>
      <form id="registerForm">
        <div class="mb-3">
          <label for="name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input type="text" class="form-control" id="name" required />
        </div>
        <div class="mb-3">
          <label for="nationalId" class="form-label">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
          <input type="text" class="form-control" id="nationalId" maxlength="13" required />
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <input type="tel" class="form-control" id="phone" required />
        </div>
        <input type="hidden" id="userId" />
        <button type="submit" class="btn btn-success w-100">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
      </form>
    </div>
  </div>

  <script>
    const liffId = "2007284346-W3BaQ64M"; // << ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwRpK88g5llK66k7aPeoMhkToaH2qfbvTBWL7eR_yX8tJ6UUVcbulGfODmNXZjgZC8/exec"; // << ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    document.addEventListener("DOMContentLoaded", async function () {
      try {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        const profile = await liff.getProfile();
        document.getElementById("lineName").innerText = profile.displayName;
        document.getElementById("userId").value = profile.userId;
      } catch (err) {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: " + err.message);
      }

      document.getElementById("registerForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const nationalId = document.getElementById("nationalId").value.trim();
        if (nationalId.length !== 13 || !/^\d{13}$/.test(nationalId)) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          return;
        }

        const formData = {
          name: document.getElementById("name").value.trim(),
          nationalIdHash: CryptoJS.SHA256(nationalId).toString(),
          phone: document.getElementById("phone").value.trim(),
          userId: document.getElementById("userId").value
        };

        try {
          const res = await fetch(scriptUrl, {
            method: "POST",
            body: JSON.stringify(formData),
            headers: { "Content-Type": "application/json" },
          });
          const result = await res.json();
          if (result.status === "success") {
            alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ");
          } else if (result.status === "duplicate") {
            alert("‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
          } else {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + result.message);
          }
        } catch (err) {
          alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: " + err.message);
        }
      });
    });
  </script>
</body>
</html>

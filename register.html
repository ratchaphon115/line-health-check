<!DOCTYPE html>
<html>
<head>
  <title>Register</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>Health Check Registration</h2>
  <form id="registerForm">
    <input type="text" id="name" placeholder="Full Name" required><br>
    <input type="text" id="nationalId" placeholder="National ID" required><br>
    <input type="text" id="phone" placeholder="Phone Number" required><br>
    <button type="submit">Register</button>
  </form>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxvtkCUN7ZnxdTdlwpp0TrJz25ule4c9E8NU-93Rem66AwligXRoTOHBY5XxTZGaJwkyw/exec";

    let userId = "";

    async function checkExisting(userId) {
      const res = await fetch(`${GAS_URL}?path=register`);
      const data = await res.json();
      return data.find(u => u.userId === userId);
    }

    async function init() {
      await liff.init({ liffId: "2007284346-W3BaQ64M" });
      if (!liff.isLoggedIn()) liff.login();

      const profile = await liff.getProfile();
      userId = profile.userId;

      const existing = await checkExisting(userId);
      if (existing) {
        alert("คุณได้ลงทะเบียนแล้ว");
        document.getElementById("registerForm").style.display = "none";
      }
    }

    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = {
        name: document.getElementById("name").value,
        nationalId: document.getElementById("nationalId").value,
        phone: document.getElementById("phone").value,
        userId: userId
      };

      await fetch(`${GAS_URL}?path=register`, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      alert("ลงทะเบียนสำเร็จ!");
      liff.closeWindow();
    });

    init();
  </script>
</body>
</html>

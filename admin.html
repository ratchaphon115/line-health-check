<!-- admin.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Health Check</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-50 font-sans">
  <div class="max-w-xl mx-auto mt-10 p-6 bg-white rounded-2xl shadow-md">
    <h1 class="text-2xl font-bold mb-6">ğŸ” Admin Login</h1>
    <button onclick="loginWithLine()" class="w-full bg-green-600 text-white py-2 rounded-xl shadow hover:bg-green-700">Login with LINE</button>
  </div>

  <div id="adminPanel" class="hidden max-w-xl mx-auto mt-10 p-6 bg-white rounded-2xl shadow-md">
    <h2 class="text-xl font-semibold mb-4">ğŸ“‹ Submit Health Check Result</h2>

    <label class="block mb-2 text-sm font-medium">Patient National ID</label>
    <input type="text" id="nationalId" class="w-full border p-2 rounded-xl mb-4" placeholder="Enter national ID">
    <button onclick="checkPatient()" class="bg-blue-600 text-white py-2 px-4 rounded-xl hover:bg-blue-700">Check</button>

    <div id="patientInfo" class="hidden mt-4">
      <p><strong>Name:</strong> <span id="patientName"></span></p>
      <p><strong>User ID:</strong> <span id="patientUserId"></span></p>

      <label class="block mt-4 mb-2 text-sm font-medium">Date</label>
      <input type="date" id="testDate" class="w-full border p-2 rounded-xl mb-4">

      <label class="block mb-2 text-sm font-medium">Upload Result</label>
      <input type="file" id="resultFile" class="mb-4">

      <button onclick="uploadResult()" class="bg-green-600 text-white py-2 px-4 rounded-xl hover:bg-green-700">Upload</button>
    </div>
  </div>

  <script>
    const adminUserIds = ["Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"]; // à¹ƒà¸ªà¹ˆ LINE userId à¸‚à¸­à¸‡à¹à¸­à¸”à¸¡à¸´à¸™
    let adminId = null;

    function loginWithLine() {
      liff.init({ liffId: "YOUR_LIFF_ID" })
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            const idToken = liff.getIDToken();
            liff.getProfile().then(profile => {
              if (adminUserIds.includes(profile.userId)) {
                adminId = profile.userId;
                document.querySelector("#adminPanel").classList.remove("hidden");
                document.querySelector(".max-w-xl > button").classList.add("hidden");
              } else {
                alert("Access Denied: Not an Admin");
              }
            });
          }
        });
    }

    async function checkPatient() {
      const nationalId = document.getElementById("nationalId").value;
      const hash = await sha256(nationalId);
      const res = await fetch(`https://script.google.com/macros/s/AKfycbw794LR1VS-gWJkkRV529gofIbDtglHmtNgF407if-o62L8Z_n2gDAK14TJVgqcUST1UA/exec?lookupId=${nationalId}`);
      const data = await res.json();
      if (data.name && data.userId) {
        document.getElementById("patientName").textContent = data.name;
        document.getElementById("patientUserId").textContent = data.userId;
        document.getElementById("patientInfo").classList.remove("hidden");
      } else {
        alert("à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰");
      }
    }

    async function uploadResult() {
      const nationalId = document.getElementById("nationalId").value;
      const userId = document.getElementById("patientUserId").textContent;
      const date = document.getElementById("testDate").value;
      const file = document.getElementById("resultFile").files[0];
      const nationalIdHash = await sha256(nationalId);

      const formData = new FormData();
      formData.append("file", file);
      formData.append("meta", JSON.stringify({ userId, nationalIdHash, date }));

      const res = await fetch("https://script.google.com/macros/s/AKfycbw794LR1VS-gWJkkRV529gofIbDtglHmtNgF407if-o62L8Z_n2gDAK14TJVgqcUST1UA/exec", {
        method: "POST",
        body: formData
      });
      const result = await res.json();
      alert(result.success ? "Upload success" : result.message);
    }

    async function sha256(text) {
      const msgUint8 = new TextEncoder().encode(text);
      const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
  </script>
</body>
</html>

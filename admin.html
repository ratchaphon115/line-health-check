<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Upload</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background: #f9fafb;
      padding: 2rem;
      max-width: 500px;
      margin: auto;
    }
    h2 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    input, button, label, select {
      display: block;
      width: 100%;
      margin-bottom: 1rem;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
    }
    button {
      background-color: #4f46e5;
      color: white;
      border: none;
      cursor: pointer;
    }
    .hidden { display: none; }
    .error { color: red; text-align: center; }
    .success { color: green; text-align: center; }
  </style>
</head>
<body>
  <h2>ระบบอัปโหลดผลตรวจ</h2>
  <div id="status" class="error"></div>

  <label>เลขบัตรประชาชน</label>
  <input type="text" id="nationalId" maxlength="13" placeholder="ใส่เลขบัตร 13 หลัก" />
  <button onclick="checkNationalId()">ตรวจสอบ</button>

  <div id="patientSection" class="hidden">
    <div><strong>ชื่อ:</strong> <span id="patientName"></span></div>
    <label>วันที่ตรวจ (วัน/เดือน/ปี พ.ศ.)</label>
    <input type="text" id="testDate" placeholder="01/01/2568" />
    <label>อัปโหลดไฟล์ผลตรวจ</label>
    <input type="file" id="fileUpload" accept="image/*,.pdf" />
    <button onclick="uploadResult()">บันทึกผลตรวจ</button>
  </div>

  <script>
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbycgn6GnCNfVvcuXU7gaG5pC8nRLS5hZA4aShE_bLMnJN2e-zdATeYppt3yxv1n_3zaKw/exec';
    const adminWhitelist = ['U5d52f4b6a6bc38d5210e325310486754']; // ใส่ userId ของ admin ที่อนุญาต

    let liffUserId = null;
    let selectedUserId = null;

    async function checkNationalId() {
      const id = document.getElementById('nationalId').value.trim();
      if (id.length !== 13) {
        return showStatus('เลขบัตรไม่ถูกต้อง', true);
      }
      const hash = await sha256(id);
      const res = await fetch(`${scriptUrl}?action=checkNationalId&nationalIdHash=${hash}`);
      const data = await res.json();
      if (!data.success) {
        return showStatus('ไม่พบข้อมูลผู้ป่วย', true);
      }
      document.getElementById('patientName').textContent = data.name;
      selectedUserId = data.userId;
      showStatus('', false);
      document.getElementById('patientSection').classList.remove('hidden');
    }

    async function uploadResult() {
      const file = document.getElementById('fileUpload').files[0];
      const date = document.getElementById('testDate').value.trim();
      const id = document.getElementById('nationalId').value.trim();
      if (!file || !date || !id || !selectedUserId) return showStatus('ข้อมูลไม่ครบ', true);

      const hash = await sha256(id);
      const reader = new FileReader();
      reader.onloadend = async function () {
        const base64 = reader.result;
        const body = JSON.stringify({
          userId: selectedUserId,
          nationalIdHash: hash,
          date: date,
          fileName: file.name,
          fileBase64: base64
        });
        const res = await fetch(scriptUrl, {
          method: 'POST',
          body: body,
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        showStatus(data.status === 'success' ? 'อัปโหลดสำเร็จ' : 'เกิดข้อผิดพลาด', data.status !== 'success');
      };
      reader.readAsDataURL(file);
    }

    async function sha256(str) {
      const buffer = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest('SHA-256', buffer);
      return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function showStatus(msg, isError) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = isError ? 'error' : 'success';
    }

    async function initLiff() {
      await liff.init({ liffId: '2007284346-47ml8AjJ' });
      if (!liff.isLoggedIn()) liff.login();
      const profile = await liff.getProfile();
      liffUserId = profile.userId;
      if (!adminWhitelist.includes(liffUserId)) {
        document.body.innerHTML = '<div class="error">คุณไม่มีสิทธิ์เข้าถึงหน้านี้</div>';
      }
    }

    window.onload = initLiff;
  </script>
</body>
</html>

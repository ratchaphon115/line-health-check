<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
</head>
<body>
  <h2>อัปโหลดผลตรวจ</h2>
  <input type="file" id="file" />
  <input type="text" id="userId" placeholder="userId" />
  <input type="text" id="nationalId" placeholder="เลขบัตร ปชช." />
  <input type="text" id="date" placeholder="วันที่ตรวจ (01/01/2567)" />
  <button onclick="submitResult()">ส่งผลตรวจ</button>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    async function submitResult() {
      await liff.init({ liffId: 'your-liff-id' });
      if (!liff.isLoggedIn()) return liff.login();

      const userId = liff.getDecodedIDToken().sub;

      const res = await fetch(`https://script.google.com/macros/s/AKfycbw794LR1VS-gWJkkRV529gofIbDtglHmtNgF407if-o62L8Z_n2gDAK14TJVgqcUST1UA/exec?action=isAdmin&userId=${userId}`);
      const data = await res.json();

      if (!data.success) return alert("ไม่ใช่แอดมิน");

      const fileInput = document.getElementById('file');
      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = async function () {
        const base64 = reader.result.split(',')[1];
        const payload = {
          meta: JSON.stringify({
            userId: document.getElementById('userId').value,
            nationalIdHash: await hash(document.getElementById('nationalId').value),
            date: document.getElementById('date').value
          }),
          file: base64
        };

        const formData = new FormData();
        formData.append('meta', payload.meta);
        formData.append('file', file);

        const upload = await fetch('https://script.google.com/macros/s/AKfycbw794LR1VS-gWJkkRV529gofIbDtglHmtNgF407if-o62L8Z_n2gDAK14TJVgqcUST1UA/exec', {
          method: 'POST',
          body: formData
        });

        const result = await upload.json();
        alert(result.success ? 'อัปโหลดสำเร็จ' : 'ล้มเหลว');
      };

      reader.readAsDataURL(file);
    }

    async function hash(text) {
      const buffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
      return [...new Uint8Array(buffer)].map(x => x.toString(16).padStart(2, '0')).join('');
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Admin | ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 1rem; }
    h2 { color: teal; }
    input, button { width: 100%; padding: 0.5rem; margin-bottom: 1rem; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h2>
  <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
  <input type="text" id="nationalId" maxlength="13" />
  <button onclick="checkNationalId()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
  <p id="userInfo"></p>

  <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</label>
  <input type="date" id="checkDate" />

  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</label>
  <input type="file" id="fileInput" />

  <button onclick="uploadResult()">‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</button>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbxKtM8_vFlVIMNiuSh6g4DlzxUMpdiL7toOtZkbKXiPi3nKbGsNsaQ4T-9loC7KuQR4ig/exec";
    let matchedUserId = null;
    let hashedNationalId = null;

    async function sha256(str) {
      const buf = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest("SHA-256", buf);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function checkNationalId() {
      const id = document.getElementById("nationalId").value.trim();
      if (id.length !== 13) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å");
      hashedNationalId = await sha256(id);

      try {
        const res = await fetch(`${endpoint}?action=checkUserId&nationalIdHash=${hashedNationalId}`);
        const data = await res.json();
        if (data.found) {
          matchedUserId = data.userId;
          document.getElementById("userInfo").innerHTML = `‚úÖ ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <strong>${data.name}</strong>`;
          document.getElementById("userInfo").className = "success";
        } else {
          matchedUserId = null;
          document.getElementById("userInfo").textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
          document.getElementById("userInfo").className = "error";
        }
      } catch (err) {
        console.error(err);
        document.getElementById("userInfo").textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
      }
    }

    async function uploadResult() {
      const file = document.getElementById("fileInput").files[0];
      const date = document.getElementById("checkDate").value;
      if (!file || !date || !matchedUserId) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");

      const base64 = await toBase64(file);
      const payload = {
        userId: matchedUserId,
        nationalIdHash: hashedNationalId,
        fileBase64: base64,
        date,
        fileName: file.name
      };

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.status === "success") {
          alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        } else {
          alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
        }
      } catch (err) {
        alert("‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
      }
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>

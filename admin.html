<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Upload Health Result</title>
  <style>
    #drop-zone {
      border: 2px dashed #aaa;
      padding: 20px;
      text-align: center;
      border-radius: 10px;
    }
    #drop-zone.hover {
      background-color: #e0f7fa;
    }
  </style>
</head>
<body>
  <h2>อัปโหลดผลตรวจสุขภาพ</h2>

  <label>เลขบัตรประชาชน:</label>
  <input type="text" id="nationalId" maxlength="13" />
  <button onclick="checkNationalId()">ตรวจสอบ</button>
  <p id="userInfo"></p>

  <label>วันที่ตรวจ:</label>
  <input type="date" id="checkDate" />

  <div id="drop-zone">
    ลากไฟล์ผลตรวจมาวางที่นี่ หรือ Ctrl+V เพื่อวางไฟล์
  </div>
  <p id="fileInfo"></p>

  <button onclick="uploadResult()">อัปโหลดผลตรวจ</button>

  <script>
    let selectedFile = null;
    let matchedUserId = null;
    let hashedNationalId = null;

    // SHA256 hashing
    async function sha256(str) {
      const buffer = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest("SHA-256", buffer);
      return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // ตรวจสอบเลขบัตรประชาชน
    async function checkNationalId() {
      const nationalId = document.getElementById("nationalId").value.trim();
      if (nationalId.length !== 13) return alert("เลขบัตรไม่ถูกต้อง");

      hashedNationalId = await sha256(nationalId);

      const response = await fetch('https://script.google.com/macros/s/AKfycbwO1Y4aUDfuBaWK3go1iK-NWC9iTBt4aKcAo9m_dvisV1Czi4CgqCfFsf2MWn023N325g/exec?action=checkUserId&nationalIdHash=' + hashedNationalId);
      const data = await response.json();

      if (data.found) {
        matchedUserId = data.userId;
        document.getElementById("userInfo").textContent = `ชื่อผู้ใช้: ${data.name}`;
      } else {
        document.getElementById("userInfo").textContent = "ไม่พบข้อมูล";
        matchedUserId = null;
      }
    }

    // รองรับ drag & drop และ paste
    const dropZone = document.getElementById("drop-zone");
    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.classList.add("hover");
    });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("hover"));
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("hover");
      selectedFile = e.dataTransfer.files[0];
      document.getElementById("fileInfo").textContent = `ไฟล์: ${selectedFile.name}`;
    });

    document.addEventListener("paste", e => {
      const items = e.clipboardData.items;
      for (let item of items) {
        if (item.kind === "file") {
          selectedFile = item.getAsFile();
          document.getElementById("fileInfo").textContent = `ไฟล์: ${selectedFile.name}`;
        }
      }
    });

    // อัปโหลดผลตรวจ
    async function uploadResult() {
      if (!matchedUserId || !selectedFile) return alert("กรอกข้อมูลให้ครบ");

      const date = document.getElementById("checkDate").value;
      if (!date) return alert("กรุณาเลือกวันที่ตรวจ");

      const formData = new FormData();
      formData.append("file", selectedFile);
      formData.append("userId", matchedUserId);
      formData.append("nationalIdHash", hashedNationalId);
      formData.append("date", date);

      const res = await fetch('https://script.google.com/macros/s/AKfycbwO1Y4aUDfuBaWK3go1iK-NWC9iTBt4aKcAo9m_dvisV1Czi4CgqCfFsf2MWn023N325g/exec', {
        method: 'POST',
        body: formData
      });

      const result = await res.json();
      if (result.status === "success") {
        alert("อัปโหลดเรียบร้อย");
      } else {
        alert("เกิดข้อผิดพลาด");
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏î‡∏π‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <div class="card shadow-lg p-4">
      <h3 class="text-center mb-4">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h3>
      <div id="loading" class="text-center">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

      <div id="mainContent" class="d-none">
        <p class="text-center">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì <strong><span id="lineName">...</span></strong></p>
        <div class="mb-3">
          <label for="dateSelect" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</label>
          <select class="form-select" id="dateSelect"></select>
        </div>

        <div class="mb-3">
          <label for="nationalId" class="form-label">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
          <input type="text" class="form-control" id="nationalId" maxlength="13" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ 13 ‡∏´‡∏•‡∏±‡∏Å" />
        </div>

        <button id="checkBtn" class="btn btn-primary w-100">‡∏î‡∏π‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</button>

        <div id="resultBox" class="mt-4 d-none text-center">
          <p>‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
          <img id="resultImage" class="img-fluid rounded shadow" alt="‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à" />
        </div>

        <div id="errorBox" class="alert alert-danger mt-3 d-none text-center"></div>
      </div>

      <div id="notRegistered" class="alert alert-warning d-none text-center">
        ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à<br />
        <a href="register.html" class="btn btn-outline-primary mt-2">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
      </div>
    </div>
  </div>

  <script>
    const liffId = "2007284346-Kb68WM5d"; // <-- ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const apiUrl = "https://api.sheetbest.com/sheets/521a8898-2824-4585-81ca-deaf3117c530"; // <-- URL ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Apps Script ‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö register.html

    let userId = "";
    let resultData = [];

    async function fetchResultData() {
      try {
        const res = await fetch(`${apiUrl}?action=getResults&userId=${userId}`);
        return await res.json();
      } catch (err) {
        console.error(err);
        return { status: "error", message: err.message };
      }
    }

    document.addEventListener("DOMContentLoaded", async function () {
      try {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        userId = profile.userId;
        document.getElementById("lineName").innerText = profile.displayName;

        const data = await fetchResultData();

        document.getElementById("loading").classList.add("d-none");

        if (data.status === "not_found") {
          document.getElementById("notRegistered").classList.remove("d-none");
          return;
        }

        resultData = data.results;
        const dateSelect = document.getElementById("dateSelect");

        resultData.forEach(entry => {
          const option = document.createElement("option");
          option.value = entry.date;
          option.text = entry.date;
          dateSelect.appendChild(option);
        });

        document.getElementById("mainContent").classList.remove("d-none");
      } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
      }
    });

    document.getElementById("checkBtn").addEventListener("click", function () {
      const selectedDate = document.getElementById("dateSelect").value;
      const nationalId = document.getElementById("nationalId").value.trim();

      const errorBox = document.getElementById("errorBox");
      const resultBox = document.getElementById("resultBox");
      const resultImage = document.getElementById("resultImage");

      errorBox.classList.add("d-none");
      resultBox.classList.add("d-none");

      if (nationalId.length !== 13 || !/^\d{13}$/.test(nationalId)) {
        errorBox.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
        errorBox.classList.remove("d-none");
        return;
      }

      const nationalIdHash = CryptoJS.SHA256(nationalId).toString();
      const matched = resultData.find(r => r.date === selectedDate && r.nationalIdHash === nationalIdHash);

      if (matched) {
        resultImage.src = matched.resultImageUrl;
        resultBox.classList.remove("d-none");
      } else {
        errorBox.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        errorBox.classList.remove("d-none");
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ดูผลตรวจสุขภาพ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body class="bg-light">
<div class="container mt-5">
  <div id="alertBox" class="alert d-none text-center" role="alert"></div>

  <div class="card shadow-lg p-4" id="resultCard" style="display: none;">
    <h3 class="text-center mb-4">ผลตรวจสุขภาพของคุณ</h3>
    <div class="mb-3">
      <label for="dateSelect" class="form-label">เลือกวันที่ตรวจ</label>
      <select class="form-select" id="dateSelect"></select>
    </div>
    <div class="mb-3">
      <label for="confirmNationalId" class="form-label">ยืนยันเลขบัตรประชาชน (13 หลัก)</label>
      <input type="text" class="form-control" id="confirmNationalId" maxlength="13" required>
    </div>
    <button id="viewResultBtn" class="btn btn-primary w-100">ดูผลตรวจ</button>
    <div id="resultImage" class="mt-4 text-center"></div>
  </div>
</div>

<script>
const liffId = "2007284346-Kb68WM5d"; // <-- แก้ตรงนี้
const sheetBestUrl = "https://api.sheetbest.com/sheets/521a8898-2824-4585-81ca-deaf3117c530"; // <-- แก้ตรงนี้

let userId = "";
let resultsData = [];

function showAlert(message, type = "info") {
  const box = document.getElementById("alertBox");
  box.innerText = message;
  box.className = `alert alert-${type} text-center`;
  box.classList.remove("d-none");
}

function populateDateSelect(dates) {
  const select = document.getElementById("dateSelect");
  select.innerHTML = "";
  [...new Set(dates)].forEach(date => {
    const option = document.createElement("option");
    option.value = date;
    option.innerText = date;
    select.appendChild(option);
  });
}

function displayImage(url) {
  const container = document.getElementById("resultImage");
  container.innerHTML = `<img src="${url}" alt="ผลตรวจ" class="img-fluid rounded shadow">`;
}

async function init() {
  try {
    await liff.init({ liffId });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    userId = profile.userId;

    const res = await fetch(sheetBestUrl);
    const data = await res.json();
    resultsData = data.filter(row => row.userId === userId);

    if (resultsData.length === 0) {
      showAlert("❌ ไม่พบข้อมูลการลงทะเบียนของคุณ กรุณาลงทะเบียนก่อน", "danger");
      setTimeout(() => window.location.href = "register.html", 3000);
      return;
    }

    populateDateSelect(resultsData.map(row => row.date));
    document.getElementById("resultCard").style.display = "block";
  } catch (err) {
    showAlert("❌ ระบบมีปัญหา: " + err.message, "danger");
  }
}

init();

// กดปุ่มดูผล

document.getElementById("viewResultBtn").addEventListener("click", () => {
  const selectedDate = document.getElementById("dateSelect").value;
  const nationalId = document.getElementById("confirmNationalId").value.trim();

  if (!/^[0-9]{13}$/.test(nationalId)) {
    showAlert("⚠️ กรุณากรอกเลขบัตรประชาชนให้ถูกต้อง (13 หลัก)", "warning");
    return;
  }

  const hashId = CryptoJS.SHA256(nationalId).toString();
  const result = resultsData.find(row => row.date === selectedDate && row.nationalIdHash === hashId);

  if (!result) {
    showAlert("❌ ไม่พบผลตรวจสำหรับข้อมูลที่ระบุ", "danger");
    return;
  }

  showAlert("✅ แสดงผลตรวจสำเร็จ", "success");
  displayImage(result.resultImageUrl);
});
</script>
</body>
</html>
